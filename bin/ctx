#!/usr/bin/env fish
function ctx -d "Print a file or stdin, wrapped in xml tags."
    argparse n/no_copy m/no_markdown 't/tag=' -- $argv
    or return
    set _flag_tag (set -q _flag_tag && echo $_flag_tag || echo "file")
    set _flag_t $_flag_tag

    set --local output ""

    if test -z "$_flag_no_markdown"
        set --append output "```"
    end

    for path in $argv
        set --append output "<$_flag_tag path=\"$path\">"
        set --append output (command cat -- $path)
        set --append output "</$_flag_tag>"
    end

    if test -z "$_flag_no_markdown"
        set --append output "```"
    end

    printf "%s\n" $output

    if test -z "$_flag_no_copy"
        if command -q pbcopy
            set copy_cmd pbcopy
        else if command -q wl-copy
            set copy_cmd wl-copy
        else if command -q xclip
            set copy_cmd xclip -selection clipboard
        else if command -q xsel
            set copy_cmd xsel --clipboard --input
        else if command -q clip.exe
            set copy_cmd clip.exe
        end

        if test (count $copy_cmd) -eq 0
            echo "ctx: no copy command found" >&2
            return 1
        end
        if test -z "$copy_cmd"
            echo "ctx: no copy command found" >&2
            return 1
        end
        printf "%s\n" $output | $copy_cmd
    end
end

ctx $argv
